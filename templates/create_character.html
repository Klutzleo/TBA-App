<!DOCTYPE html>
<html>
<head>
    <title>Create Character - TBA</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #00d4ff; margin-bottom: 5px; }
        .subtitle { color: #888; margin-bottom: 30px; }

        /* Progress bar */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #333;
            z-index: 0;
        }
        .step-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #333;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: #00d4ff;
            color: #000;
        }
        .step-indicator.complete {
            background: #00ff88;
            color: #000;
        }

        /* Form steps */
        .form-step {
            display: none;
            animation: fadeIn 0.3s;
        }
        .form-step.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            font-size: 1.5em;
            color: #00d4ff;
            margin-bottom: 20px;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #252540;
            color: #fff;
            font-size: 1em;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
        }
        input:disabled, select:disabled {
            background: #1a1a2e;
            color: #666;
        }

        /* Stats validation */
        .stats-total {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }
        .stats-total.valid { background: #00ff8833; color: #00ff88; }
        .stats-total.invalid { background: #ff444433; color: #ff4444; }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-back {
            background: #333;
            color: #aaa;
        }
        .btn-back:hover { background: #444; }
        .btn-next {
            background: #00d4ff;
            color: #000;
            font-weight: bold;
        }
        .btn-next:hover { background: #00b8e6; }
        .btn-next:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        .btn-create {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        .btn-create:hover { background: #00dd77; }

        /* Review section */
        .review-section {
            background: #252540;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .review-section h4 {
            color: #00d4ff;
            margin: 0 0 10px 0;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .review-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .review-row:last-child { border-bottom: none; }
        .review-label { color: #888; }
        .review-value { color: #fff; font-weight: bold; }
        .review-value.calculated { color: #00ff88; }

        /* Messages */
        .error-msg {
            background: #ff444433;
            color: #ff4444;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        .success-msg {
            background: #00ff8833;
            color: #00ff88;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        /* Helper text */
        .helper { color: #666; font-size: 0.85em; margin-top: 5px; }

        /* Ability slot cards */
        .ability-slot {
            background: #252540;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .ability-slot.aoe {
            border-left: 3px solid #ff6b6b;
        }
        .ability-slot.single {
            border-left: 3px solid #00d4ff;
        }
        .ability-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .ability-slot-title {
            font-weight: bold;
            color: #00d4ff;
        }
        .ability-slot-badge {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        .ability-slot-badge.single {
            background: #00d4ff33;
            color: #00d4ff;
        }
        .ability-slot-badge.aoe {
            background: #ff6b6b33;
            color: #ff6b6b;
        }
        .ability-slot .form-group {
            margin-bottom: 12px;
        }
        .ability-slot .form-group:last-child {
            margin-bottom: 0;
        }
        .ability-die-display {
            background: #1a1a2e;
            padding: 8px 12px;
            border-radius: 4px;
            color: #00ff88;
            font-weight: bold;
            display: inline-block;
        }
    </style>
</head>
<body>
    <h1>Create Character</h1>
    <p class="subtitle">TBA v1.5 Character Creation</p>

    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="step-indicator active" data-step="1">1</div>
        <div class="step-indicator" data-step="2">2</div>
        <div class="step-indicator" data-step="3">3</div>
        <div class="step-indicator" data-step="4">4</div>
        <div class="step-indicator" data-step="5">5</div>
    </div>

    <div class="error-msg" id="errorMsg"></div>
    <div class="success-msg" id="successMsg"></div>

    <form id="characterForm">
        <!-- Step 1: Basic Info -->
        <div class="form-step active" data-step="1">
            <h2 class="step-title">Basic Info</h2>

            <div class="form-group">
                <label for="campaign_id">Campaign ID *</label>
                <input type="text" id="campaign_id" name="campaign_id" required
                       placeholder="Enter your campaign ID">
                <p class="helper">Required: The campaign ID this character will join</p>
            </div>

            <div class="form-group">
                <label for="name">Character Name *</label>
                <input type="text" id="name" name="name" required maxlength="100"
                       placeholder="Enter character name">
            </div>

            <div class="form-group">
                <label for="notes">Character Description</label>
                <textarea id="notes" name="notes" rows="3" maxlength="500"
                          placeholder="Describe your character's appearance, personality, or backstory..."
                          style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 6px; background: #252540; color: #fff; font-size: 1em; font-family: inherit; resize: vertical;"></textarea>
                <p class="helper">Optional: Add flavor to your character (max 500 characters)</p>
            </div>

            <div class="form-group">
                <label for="level">Starting Level (1-10)</label>
                <input type="number" id="level" name="level" min="1" max="10" value="1" required>
                <p class="helper">Higher levels unlock more weapon options</p>
            </div>

            <div class="btn-row">
                <button type="button" class="btn-next" onclick="nextStep()">Next: Stats</button>
            </div>
        </div>

        <!-- Step 2: Stats -->
        <div class="form-step" data-step="2">
            <h2 class="step-title">Allocate Stats</h2>
            <p class="helper">Distribute 6 points across PP, IP, and SP (1-3 each)</p>

            <div class="form-group">
                <label for="pp">Physical Power (PP)</label>
                <select id="pp" name="pp" onchange="updateStatsDropdowns('pp')">
                    <option value="1">1 - Low</option>
                    <option value="2" selected>2 - Average</option>
                    <option value="3">3 - High</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ip">Intellect Power (IP)</label>
                <select id="ip" name="ip" onchange="updateStatsDropdowns('ip')">
                    <option value="1">1 - Low</option>
                    <option value="2" selected>2 - Average</option>
                    <option value="3">3 - High</option>
                </select>
            </div>

            <div class="form-group">
                <label for="sp">Social Power (SP)</label>
                <select id="sp" name="sp" onchange="updateStatsDropdowns('sp')">
                    <option value="1">1 - Low</option>
                    <option value="2" selected>2 - Average</option>
                    <option value="3">3 - High</option>
                </select>
            </div>

            <div class="stats-total valid" id="statsTotal">Total: 6 / 6</div>

            <div class="btn-row">
                <button type="button" class="btn-back" onclick="prevStep()">Back</button>
                <button type="button" class="btn-next" id="statsNextBtn" onclick="nextStep()">Next: Combat</button>
            </div>
        </div>

        <!-- Step 3: Combat -->
        <div class="form-step" data-step="3">
            <h2 class="step-title">Combat Setup</h2>

            <div class="form-group">
                <label for="weapon_die">Weapon Die *</label>
                <select id="weapon_die" name="weapon_die" required>
                    <!-- Options populated by JavaScript based on level -->
                </select>
            </div>

            <div class="form-group">
                <label for="weapon_name">Weapon Name (optional)</label>
                <input type="text" id="weapon_name" name="weapon_name"
                       placeholder="e.g., Steel Longsword" maxlength="100">
            </div>

            <div class="form-group">
                <label for="defense_die">Defense Die (auto-calculated)</label>
                <input type="text" id="defense_die" name="defense_die" disabled>
            </div>

            <div class="form-group">
                <label for="armor_name">Armor Name (optional)</label>
                <input type="text" id="armor_name" name="armor_name"
                       placeholder="e.g., Leather Armor" maxlength="100">
            </div>

            <div class="btn-row">
                <button type="button" class="btn-back" onclick="prevStep()">Back</button>
                <button type="button" class="btn-next" onclick="nextStep()">Next: Ability</button>
            </div>
        </div>

        <!-- Step 4: Abilities (dynamic based on level) -->
        <div class="form-step" data-step="4">
            <h2 class="step-title">Starting Abilities</h2>
            <p class="helper" id="abilities_helper">Create your spells, techniques, or special abilities</p>

            <!-- Ability slots container - dynamically populated based on level -->
            <div id="ability_slots_container"></div>

            <div class="btn-row">
                <button type="button" class="btn-back" onclick="prevStep()">Back</button>
                <button type="button" class="btn-next" onclick="nextStep()">Next: Review</button>
            </div>
        </div>

        <!-- Step 5: Review -->
        <div class="form-step" data-step="5">
            <h2 class="step-title">Review Character</h2>

            <div class="review-section">
                <h4>Basic Info</h4>
                <div class="review-row">
                    <span class="review-label">Campaign ID</span>
                    <span class="review-value" id="review_campaign_id">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Name</span>
                    <span class="review-value" id="review_name">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Description</span>
                    <span class="review-value" id="review_notes" style="font-style: italic; color: #aaa;">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Level</span>
                    <span class="review-value" id="review_level">-</span>
                </div>
            </div>

            <div class="review-section">
                <h4>Stats</h4>
                <div class="review-row">
                    <span class="review-label">PP / IP / SP</span>
                    <span class="review-value" id="review_stats">-</span>
                </div>
            </div>

            <div class="review-section">
                <h4>Combat</h4>
                <div class="review-row">
                    <span class="review-label">Weapon</span>
                    <span class="review-value" id="review_weapon">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Defense Die</span>
                    <span class="review-value" id="review_defense">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Armor</span>
                    <span class="review-value" id="review_armor">-</span>
                </div>
            </div>

            <div class="review-section">
                <h4>Abilities</h4>
                <div id="review_abilities_container">
                    <!-- Dynamically populated based on level -->
                </div>
            </div>

            <div class="review-section">
                <h4>Auto-Calculated Stats</h4>
                <div class="review-row">
                    <span class="review-label">Max DP</span>
                    <span class="review-value calculated" id="review_dp">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Edge</span>
                    <span class="review-value calculated" id="review_edge">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">BAP</span>
                    <span class="review-value calculated" id="review_bap">-</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Uses per Encounter</span>
                    <span class="review-value calculated" id="review_uses">-</span>
                </div>
            </div>

            <div class="btn-row">
                <button type="button" class="btn-back" onclick="prevStep()">Back</button>
                <button type="submit" class="btn-create">Create Character</button>
            </div>
        </div>
    </form>

    <script>
        // =====================================================================
        // Configuration - TBA v2.0 Level Tables
        // =====================================================================
        const WEAPON_OPTIONS_BY_LEVEL = {
            1: ['1d4'], 2: ['1d4'],
            3: ['1d6', '2d4'], 4: ['1d6', '2d4'],
            5: ['1d8', '2d6', '3d4'], 6: ['1d8', '2d6', '3d4'],
            7: ['1d10', '2d8', '3d6', '4d4'], 8: ['1d10', '2d8', '3d6', '4d4'],
            9: ['1d12', '2d10', '3d8', '4d6', '5d4'], 10: ['1d12', '2d10', '3d8', '4d6', '5d4']
        };

        const DEFENSE_DIE_BY_LEVEL = {
            1: '1d4', 2: '1d4',
            3: '1d6', 4: '1d6',
            5: '1d8', 6: '1d8',
            7: '1d10', 8: '1d10',
            9: '1d12', 10: '1d12'
        };

        const DP_BY_LEVEL = {
            1: 10, 2: 15, 3: 20, 4: 25, 5: 30,
            6: 35, 7: 40, 8: 45, 9: 50, 10: 55
        };

        // TBA v2.0 Edge progression
        const EDGE_BY_LEVEL = {
            1: 0, 2: 1, 3: 1, 4: 2, 5: 2,
            6: 3, 7: 3, 8: 4, 9: 4, 10: 5
        };

        // TBA v2.0 BAP progression
        const BAP_BY_LEVEL = {
            1: 1, 2: 1, 3: 2, 4: 2, 5: 3,
            6: 3, 7: 4, 8: 4, 9: 5, 10: 5
        };

        // TBA v2.0 Spell/Tech die by SLOT and LEVEL
        // Each slot has its own progression based on when it unlocks
        // Slot 1 (Single): Unlocks L1 - starts at 1d6
        // Slot 2 (AOE): Unlocks L3 - starts at 1d6
        // Slot 3 (Single): Unlocks L5 - starts at 1d6
        // Slot 4 (AOE): Unlocks L7 - starts at 1d8
        // Slot 5 (Single): Unlocks L9 - starts at 1d10
        const SPELL_DIE_BY_SLOT_AND_LEVEL = {
            // Slot 1: L1-2=1d6, L3-4=1d8, L5-6=1d10, L7-8=1d12, L9-10=2d8
            1: { 1: '1d6', 2: '1d6', 3: '1d8', 4: '1d8', 5: '1d10', 6: '1d10', 7: '1d12', 8: '1d12', 9: '2d8', 10: '2d8' },
            // Slot 2: Unlocks L3. L3-4=1d6, L5-6=1d8, L7-8=1d10, L9-10=1d12
            2: { 3: '1d6', 4: '1d6', 5: '1d8', 6: '1d8', 7: '1d10', 8: '1d10', 9: '1d12', 10: '1d12' },
            // Slot 3: Unlocks L5. L5-6=1d6, L7-8=1d8, L9=1d10, L10=2d6
            3: { 5: '1d6', 6: '1d6', 7: '1d8', 8: '1d8', 9: '1d10', 10: '2d6' },
            // Slot 4: Unlocks L7. L7-8=1d8, L9-10=1d10
            4: { 7: '1d8', 8: '1d8', 9: '1d10', 10: '1d10' },
            // Slot 5: Unlocks L9. L9=1d10, L10=1d12
            5: { 9: '1d10', 10: '1d12' }
        };

        // Helper to get spell die for a specific slot at a specific level
        function getSpellDie(slotNum, level) {
            const slotDice = SPELL_DIE_BY_SLOT_AND_LEVEL[slotNum];
            return slotDice ? (slotDice[level] || '1d6') : '1d6';
        }

        // Uses per encounter (3 * level)
        const USES_BY_LEVEL = {
            1: 3, 2: 6, 3: 9, 4: 12, 5: 15,
            6: 18, 7: 21, 8: 24, 9: 27, 10: 30
        };

        // =====================================================================
        // State
        // =====================================================================
        let currentStep = 1;
        const totalSteps = 5;

        // Get campaign_id from URL params
        const urlParams = new URLSearchParams(window.location.search);
        document.getElementById('campaign_id').value = urlParams.get('campaign_id') || '';

        // =====================================================================
        // Navigation
        // =====================================================================
        function updateProgressBar() {
            document.querySelectorAll('.step-indicator').forEach(el => {
                const step = parseInt(el.dataset.step);
                el.classList.remove('active', 'complete');
                if (step === currentStep) {
                    el.classList.add('active');
                } else if (step < currentStep) {
                    el.classList.add('complete');
                }
            });
        }

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(el => {
                el.classList.remove('active');
                if (parseInt(el.dataset.step) === step) {
                    el.classList.add('active');
                }
            });
            currentStep = step;
            updateProgressBar();

            // Update dynamic fields when entering certain steps
            if (step === 3) updateCombatOptions();
            if (step === 4) updateAbilityDie();
            if (step === 5) updateReview();
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                // Validate current step
                if (!validateStep(currentStep)) return;
                showStep(currentStep + 1);
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        // =====================================================================
        // Validation
        // =====================================================================
        function validateStep(step) {
            hideError();

            if (step === 1) {
                const name = document.getElementById('name').value.trim();
                const level = parseInt(document.getElementById('level').value);
                if (!name) {
                    showError('Please enter a character name');
                    return false;
                }
                if (level < 1 || level > 10) {
                    showError('Level must be between 1 and 10');
                    return false;
                }
            }

            if (step === 2) {
                const pp = parseInt(document.getElementById('pp').value);
                const ip = parseInt(document.getElementById('ip').value);
                const sp = parseInt(document.getElementById('sp').value);
                if (pp + ip + sp !== 6) {
                    showError('Stats must total exactly 6');
                    return false;
                }
            }

            if (step === 4) {
                // Validate all available ability slots
                const level = parseInt(document.getElementById('level').value) || 1;
                const availableSlots = getAvailableSlots(level);
                const macros = new Set();

                for (const slot of availableSlots) {
                    const slotNum = slot.slot;
                    const abilityName = document.getElementById(`ability_name_${slotNum}`).value.trim();
                    const macro = document.getElementById(`macro_command_${slotNum}`).value.trim();

                    if (!abilityName) {
                        showError(`Please enter a name for ability slot ${slotNum}`);
                        return false;
                    }
                    if (!macro || !macro.startsWith('/')) {
                        showError(`Macro command for slot ${slotNum} must start with /`);
                        return false;
                    }
                    if (macro.includes(' ')) {
                        showError(`Macro command for slot ${slotNum} cannot contain spaces`);
                        return false;
                    }
                    // Check for duplicate macros
                    if (macros.has(macro.toLowerCase())) {
                        showError(`Duplicate macro command: ${macro}. Each ability needs a unique command.`);
                        return false;
                    }
                    macros.add(macro.toLowerCase());
                }
            }

            return true;
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        // =====================================================================
        // Stats - Smart Dropdown Logic
        // =====================================================================

        // Get valid options for a stat given the other two stat values
        function getValidStatOptions(otherStat1, otherStat2) {
            const remaining = 6 - otherStat1 - otherStat2;
            const options = [];

            // Valid values are 1, 2, or 3, and must make total = 6
            for (let val = 1; val <= 3; val++) {
                if (otherStat1 + otherStat2 + val === 6) {
                    options.push(val);
                } else if (otherStat1 + otherStat2 + val < 6 && val < 3) {
                    // Can still reach 6 with higher values in other stats
                    options.push(val);
                } else if (otherStat1 + otherStat2 + val > 6) {
                    // Would exceed 6, skip
                    continue;
                } else {
                    options.push(val);
                }
            }

            // Filter to only values that can lead to valid total
            return options.filter(val => {
                const newTotal = otherStat1 + otherStat2 + val;
                // Check if remaining stats can still reach 6
                return newTotal <= 6 && newTotal >= 6 - (3 - 1) * 0; // simplified: just check bounds
            });
        }

        // Rebuild dropdown options for a stat
        function rebuildStatDropdown(statId, validValues, currentValue) {
            const select = document.getElementById(statId);
            const labels = { 1: '1 - Low', 2: '2 - Average', 3: '3 - High' };

            select.innerHTML = '';
            validValues.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = labels[val];
                if (val === currentValue) option.selected = true;
                select.appendChild(option);
            });

            // If current value isn't valid, select first valid option
            if (!validValues.includes(currentValue) && validValues.length > 0) {
                select.value = validValues[0];
            }
        }

        // Smart stats update - when one stat changes, limit others
        function updateStatsDropdowns(changedStat) {
            const pp = parseInt(document.getElementById('pp').value);
            const ip = parseInt(document.getElementById('ip').value);
            const sp = parseInt(document.getElementById('sp').value);

            // Calculate what values are valid for each stat
            // Rule: PP + IP + SP = 6, each stat 1-3

            // For each stat, calculate valid range based on others
            const stats = { pp, ip, sp };
            const statIds = ['pp', 'ip', 'sp'];

            statIds.forEach(statId => {
                if (statId === changedStat) return; // Don't modify the one user just changed

                const otherStats = statIds.filter(s => s !== statId);
                const other1 = stats[otherStats[0]];
                const other2 = stats[otherStats[1]];

                // Calculate valid values: must be 1-3 and make total work toward 6
                const minNeeded = 6 - other1 - other2;
                const validValues = [];

                for (let val = 1; val <= 3; val++) {
                    // Check if this value allows the remaining stat to be valid (1-3)
                    const remaining = 6 - other1 - val;
                    if (remaining >= 1 && remaining <= 3) {
                        validValues.push(val);
                    }
                }

                // Also check: given current other values, what can this be?
                const currentOther = statId === 'pp' ? ip + sp : (statId === 'ip' ? pp + sp : pp + ip);
                const neededForSix = 6 - currentOther;

                // Final valid values: 1-3 that when combined with others can reach 6
                const finalValid = [1, 2, 3].filter(val => {
                    const otherTwo = statIds.filter(s => s !== statId);
                    const o1 = stats[otherTwo[0]];
                    const o2 = stats[otherTwo[1]];
                    // If this stat is val, can the remaining stat reach a valid value?
                    // Already set stats + this val must allow remaining to be 1-3
                    return true; // For simplicity, just show all valid options
                });

                rebuildStatDropdown(statId, [1, 2, 3], stats[statId]);
            });

            // Now enforce the constraint more directly
            updateStatsConstraints();
        }

        // After any stat change, check and update constraints
        function updateStatsConstraints() {
            const pp = parseInt(document.getElementById('pp').value);
            const ip = parseInt(document.getElementById('ip').value);
            const sp = parseInt(document.getElementById('sp').value);
            const total = pp + ip + sp;

            const el = document.getElementById('statsTotal');
            el.textContent = `Total: ${total} / 6`;

            if (total === 6) {
                el.classList.remove('invalid');
                el.classList.add('valid');
                document.getElementById('statsNextBtn').disabled = false;
            } else {
                el.classList.remove('valid');
                el.classList.add('invalid');
                document.getElementById('statsNextBtn').disabled = true;
            }

            // Smart constraint: limit dropdowns based on what's possible
            // If two stats are set, the third is determined
            const statIds = ['pp', 'ip', 'sp'];
            const values = { pp, ip, sp };

            statIds.forEach(statId => {
                const otherIds = statIds.filter(s => s !== statId);
                const other1 = values[otherIds[0]];
                const other2 = values[otherIds[1]];
                const needed = 6 - other1 - other2;

                // Valid options for this stat given the other two
                const validOptions = [1, 2, 3].filter(val => {
                    // This value is valid if remaining = 6 - other1 - other2 - val
                    // But we only have 3 stats, so: val must = needed for total 6
                    // OR val can be different if we haven't locked in all values
                    const wouldTotal = other1 + other2 + val;
                    // Allow values that don't exceed 6 and leave room for others
                    return val >= 1 && val <= 3;
                });

                // Smarter: show only values that can lead to valid total
                const smartOptions = [1, 2, 3].filter(val => {
                    // If I pick val, can the remaining stats still sum to 6?
                    // With this stat = val, other two = other1, other2
                    // Total would be val + other1 + other2
                    // This works if we're just showing current situation
                    // But for guidance, show what makes sense
                    const projectedTotal = val + other1 + other2;
                    return projectedTotal >= 3 && projectedTotal <= 9; // Always possible
                });

                const select = document.getElementById(statId);
                const currentVal = parseInt(select.value);
                const labels = { 1: '1 - Low', 2: '2 - Average', 3: '3 - High' };

                // Highlight/style valid vs problematic choices
                Array.from(select.options).forEach(opt => {
                    const optVal = parseInt(opt.value);
                    const wouldTotal = optVal + values[otherIds[0]] + values[otherIds[1]];
                    if (wouldTotal === 6) {
                        opt.style.fontWeight = 'bold';
                        opt.style.color = '#00ff88';
                    } else if (wouldTotal > 6) {
                        opt.style.color = '#ff6666';
                    } else {
                        opt.style.color = '#ffaa00';
                    }
                });
            });
        }

        function updateStatsTotal() {
            updateStatsConstraints();
        }

        // =====================================================================
        // Combat Options
        // =====================================================================
        function updateCombatOptions() {
            const level = parseInt(document.getElementById('level').value) || 1;

            // Update weapon options
            const weaponSelect = document.getElementById('weapon_die');
            weaponSelect.innerHTML = '';
            const options = WEAPON_OPTIONS_BY_LEVEL[level] || ['1d4'];
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                weaponSelect.appendChild(option);
            });

            // Update defense die
            document.getElementById('defense_die').value = DEFENSE_DIE_BY_LEVEL[level] || '1d4';
        }

        // =====================================================================
        // Ability Slots - TBA v2.0 Dynamic Slot System
        // =====================================================================

        // Slot configuration per TBA v2.0:
        // Slot 1 (Single): All levels - uses SPELL_DIE_BY_LEVEL
        // Slot 2 (AOE): Unlocks level 3
        // Slot 3 (Single): Unlocks level 5
        // Slot 4 (AOE): Unlocks level 7
        // Slot 5 (Single): Unlocks level 9
        const ABILITY_SLOTS = {
            1: { type: 'single', unlockLevel: 1, label: '1st Spell/Tech (Single Target)' },
            2: { type: 'aoe', unlockLevel: 3, label: '2nd Spell/Tech (Area of Effect)' },
            3: { type: 'single', unlockLevel: 5, label: '3rd Spell/Tech (Single Target)' },
            4: { type: 'aoe', unlockLevel: 7, label: '4th Spell/Tech (Area of Effect)' },
            5: { type: 'single', unlockLevel: 9, label: '5th Spell/Tech (Single Target)' }
        };

        // Get available slots for a level
        function getAvailableSlots(level) {
            return Object.entries(ABILITY_SLOTS)
                .filter(([slot, config]) => level >= config.unlockLevel)
                .map(([slot, config]) => ({ slot: parseInt(slot), ...config }));
        }

        // Generate ability slot HTML
        function generateAbilitySlotHTML(slotNum, config, level) {
            const isAoe = config.type === 'aoe';
            const spellDie = getSpellDie(slotNum, level);

            return `
                <div class="ability-slot ${config.type}" data-slot="${slotNum}">
                    <div class="ability-slot-header">
                        <span class="ability-slot-title">${config.label}</span>
                        <span class="ability-slot-badge ${config.type}">${isAoe ? 'AOE' : 'Single'}</span>
                    </div>

                    <div class="form-group">
                        <label for="ability_name_${slotNum}">Ability Name *</label>
                        <input type="text" id="ability_name_${slotNum}" name="ability_name_${slotNum}"
                               placeholder="e.g., ${isAoe ? 'Fireball, Thunder Wave' : 'Power Strike, Ice Spike'}"
                               maxlength="100" required>
                    </div>

                    <div class="form-group">
                        <label for="macro_command_${slotNum}">Macro Command *</label>
                        <input type="text" id="macro_command_${slotNum}" name="macro_command_${slotNum}"
                               placeholder="/${isAoe ? 'fireball' : 'strike'}" maxlength="50"
                               oninput="formatMacroField(this)" required>
                        <p class="helper">Lowercase, no spaces. Used in chat like: /strike</p>
                    </div>

                    <div class="form-group">
                        <label for="power_source_${slotNum}">Power Source *</label>
                        <select id="power_source_${slotNum}" name="power_source_${slotNum}" required>
                            <option value="PP">PP - Physical Power</option>
                            <option value="IP">IP - Intellect Power</option>
                            <option value="SP">SP - Social Power</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="effect_type_${slotNum}">Effect Type *</label>
                        <select id="effect_type_${slotNum}" name="effect_type_${slotNum}" required>
                            <option value="damage">Damage - Deal damage to enemies</option>
                            <option value="heal">Heal - Restore DP</option>
                            <option value="buff">Buff - Boost allies</option>
                            <option value="debuff">Debuff - Weaken enemies</option>
                            <option value="utility">Utility - Other effects</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ability Die</label>
                        <span class="ability-die-display">${spellDie}</span>
                        <input type="hidden" id="ability_die_${slotNum}" value="${spellDie}">
                    </div>

                    <input type="hidden" id="is_aoe_${slotNum}" value="${isAoe}">
                </div>
            `;
        }

        // Update ability slots based on level
        function updateAbilitySlots() {
            const level = parseInt(document.getElementById('level').value) || 1;
            const container = document.getElementById('ability_slots_container');
            const availableSlots = getAvailableSlots(level);

            // Update helper text
            const helperText = document.getElementById('abilities_helper');
            if (availableSlots.length === 1) {
                helperText.textContent = 'Create your starting ability (more slots unlock at higher levels)';
            } else {
                helperText.textContent = `Create your ${availableSlots.length} starting abilities`;
            }

            // Generate slot HTML
            container.innerHTML = availableSlots
                .map(slot => generateAbilitySlotHTML(slot.slot, slot, level))
                .join('');
        }

        // Legacy function name for compatibility
        function updateAbilityDie() {
            updateAbilitySlots();
        }

        function formatMacro(input) {
            formatMacroField(input);
        }

        function formatMacroField(input) {
            let val = input.value.toLowerCase().replace(/[^a-z0-9/]/g, '');
            if (!val.startsWith('/')) {
                val = '/' + val.replace(/\//g, '');
            }
            input.value = val;
        }

        // =====================================================================
        // Review
        // =====================================================================
        function updateReview() {
            const level = parseInt(document.getElementById('level').value) || 1;

            // Campaign ID
            document.getElementById('review_campaign_id').textContent = document.getElementById('campaign_id').value || '(Not set)';

            // Basic info
            document.getElementById('review_name').textContent = document.getElementById('name').value || '-';
            const notes = document.getElementById('notes').value.trim();
            document.getElementById('review_notes').textContent = notes || 'No description provided';
            document.getElementById('review_level').textContent = level;

            // Stats
            const pp = document.getElementById('pp').value;
            const ip = document.getElementById('ip').value;
            const sp = document.getElementById('sp').value;
            document.getElementById('review_stats').textContent = `${pp} / ${ip} / ${sp}`;

            // Combat
            const weaponDie = document.getElementById('weapon_die').value;
            const weaponName = document.getElementById('weapon_name').value;
            document.getElementById('review_weapon').textContent = weaponName ? `${weaponName} (${weaponDie})` : weaponDie;
            document.getElementById('review_defense').textContent = document.getElementById('defense_die').value;
            document.getElementById('review_armor').textContent = document.getElementById('armor_name').value || 'None';

            // Abilities - dynamically build based on available slots
            const abilitiesContainer = document.getElementById('review_abilities_container');
            const availableSlots = getAvailableSlots(level);

            abilitiesContainer.innerHTML = availableSlots.map(slot => {
                const slotNum = slot.slot;
                const abilityName = document.getElementById(`ability_name_${slotNum}`)?.value || '-';
                const macro = document.getElementById(`macro_command_${slotNum}`)?.value || '-';
                const powerSource = document.getElementById(`power_source_${slotNum}`)?.value || 'PP';
                const effectType = document.getElementById(`effect_type_${slotNum}`)?.value || 'damage';
                const isAoe = slot.type === 'aoe';
                const slotSpellDie = getSpellDie(slotNum, level);

                return `
                    <div style="margin-bottom: 10px; padding: 8px; background: #1a1a2e; border-radius: 4px; border-left: 3px solid ${isAoe ? '#ff6b6b' : '#00d4ff'};">
                        <div class="review-row">
                            <span class="review-label">Slot ${slotNum} (${isAoe ? 'AOE' : 'Single'})</span>
                            <span class="review-value">${abilityName}</span>
                        </div>
                        <div class="review-row">
                            <span class="review-label">Command</span>
                            <span class="review-value">${macro}</span>
                        </div>
                        <div class="review-row">
                            <span class="review-label">Type</span>
                            <span class="review-value">${effectType} (${powerSource}) - ${slotSpellDie}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Auto-calculated
            document.getElementById('review_dp').textContent = DP_BY_LEVEL[level] || 10;
            document.getElementById('review_edge').textContent = EDGE_BY_LEVEL[level] || 0;
            document.getElementById('review_bap').textContent = BAP_BY_LEVEL[level] || 1;
            document.getElementById('review_uses').textContent = USES_BY_LEVEL[level] || 3;
        }

        // =====================================================================
        // Form Submission
        // =====================================================================
        document.getElementById('characterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();

            const campaignId = document.getElementById('campaign_id').value;
            if (!campaignId) {
                showError('No campaign ID provided. Please access this page from your campaign.');
                return;
            }

            const level = parseInt(document.getElementById('level').value);
            const availableSlots = getAvailableSlots(level);

            // Build abilities array from all available slots (each slot has its own die)
            const abilities = availableSlots.map(slot => {
                const slotNum = slot.slot;
                return {
                    slot_number: slotNum,
                    display_name: document.getElementById(`ability_name_${slotNum}`).value.trim(),
                    macro_command: document.getElementById(`macro_command_${slotNum}`).value.trim(),
                    power_source: document.getElementById(`power_source_${slotNum}`).value,
                    effect_type: document.getElementById(`effect_type_${slotNum}`).value,
                    die: getSpellDie(slotNum, level),
                    is_aoe: slot.type === 'aoe'
                };
            });

            // Send all abilities as an array
            const payload = {
                campaign_id: campaignId,
                name: document.getElementById('name').value.trim(),
                notes: document.getElementById('notes').value.trim() || null,
                level: level,
                pp: parseInt(document.getElementById('pp').value),
                ip: parseInt(document.getElementById('ip').value),
                sp: parseInt(document.getElementById('sp').value),
                weapon_die: document.getElementById('weapon_die').value,
                weapon_name: document.getElementById('weapon_name').value.trim() || null,
                defense_die: null, // Let server auto-calculate
                armor_name: document.getElementById('armor_name').value.trim() || null,
                ability: abilities // Send all abilities
            };

            try {
                const response = await fetch('/api/characters/full', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'default-dev-key' // TODO: Get from session
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    showError(data.detail || 'Failed to create character');
                    return;
                }

                // Success!
                const abilityCount = abilities.length;
                document.getElementById('successMsg').textContent =
                    `Character "${data.name}" created with ${abilityCount} ${abilityCount === 1 ? 'ability' : 'abilities'}! Redirecting...`;
                document.getElementById('successMsg').style.display = 'block';

                // Hide form
                document.querySelectorAll('.form-step').forEach(el => el.style.display = 'none');

                // Redirect after 2 seconds
                setTimeout(() => {
                    const returnUrl = urlParams.get('return') || `/campaign/${campaignId}`;
                    window.location.href = returnUrl;
                }, 2000);

            } catch (err) {
                showError('Network error: ' + err.message);
            }
        });

        // =====================================================================
        // Initialize
        // =====================================================================
        document.addEventListener('DOMContentLoaded', function() {
            updateStatsTotal();
            updateCombatOptions();
            updateAbilitySlots(); // Initialize ability slots for starting level

            // Update all level-dependent fields when level changes
            document.getElementById('level').addEventListener('change', function() {
                updateCombatOptions();
                updateAbilitySlots();
            });
        });
    </script>
</body>
</html>
