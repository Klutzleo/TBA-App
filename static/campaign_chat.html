<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBA Campaign Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            display: flex;
            height: 100vh;
        }
        
        #sidebar {
            width: 250px;
            background: #16213e;
            padding: 20px;
            border-right: 2px solid #0f3460;
        }
        
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #0f3460;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-IC {
            background: #1e3a5f;
            border-left: 4px solid #4a9eff;
        }
        
        .chat-OOC {
            background: #2a2a3e;
            border-left: 4px solid #888;
            font-style: italic;
        }
        
        .narration {
            background: #3e2a5f;
            border-left: 4px solid #a855f7;
            font-weight: bold;
            text-align: center;
        }
        
        .combat_result {
            background: #5f1e1e;
            border-left: 4px solid #ef4444;
            font-family: 'Courier New', monospace;
        }
        
        .dice_roll {
            background: #1e5f3e;
            border-left: 4px solid #10b981;
        }
        
        .system {
            background: #2a2a2a;
            border-left: 4px solid #666;
            font-size: 0.9em;
            text-align: center;
            opacity: 0.7;
        }
        
        .whisper {
            background: #5f4a1e;
            border-left: 4px solid #fbbf24;
        }
        
        .timestamp {
            font-size: 0.75em;
            color: #999;
            margin-left: 10px;
        }
        
        .sender {
            font-weight: bold;
            color: #4a9eff;
            margin-right: 8px;
        }
        
        .combat-breakdown {
            font-size: 0.85em;
            margin-top: 5px;
            padding-left: 20px;
            color: #ccc;
        }
        
        #input-area {
            display: flex;
            padding: 20px;
            background: #16213e;
            border-top: 2px solid #0f3460;
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            background: #0f3460;
            border: 2px solid #1e3a5f;
            border-radius: 8px;
            color: #eee;
            font-size: 14px;
        }
        
        #message-input:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        button {
            margin-left: 10px;
            padding: 12px 24px;
            background: #4a9eff;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #3a8eef;
        }
        
        button:active {
            background: #2a7edf;
        }
        
        select {
            padding: 8px;
            background: #0f3460;
            border: 2px solid #1e3a5f;
            border-radius: 8px;
            color: #eee;
            margin-left: 10px;
        }
        
        h2 {
            color: #4a9eff;
            margin-bottom: 15px;
        }
        
        #status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .connected {
            background: #10b981;
            color: white;
        }
        
        .disconnected {
            background: #ef4444;
            color: white;
        }
        
        .user-list {
            list-style: none;
            padding: 0;
        }
        
        .user-list li {
            padding: 8px;
            margin-bottom: 5px;
            background: #0f3460;
            border-radius: 4px;
        }

        /* Tab Bar Styles */
        #tab-bar {
            display: flex;
            background: #16213e;
            border-bottom: 2px solid #0f3460;
            padding: 0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin: 0;
        }

        .tab-btn:hover {
            color: #ccc;
            background: rgba(255,255,255,0.05);
        }

        .tab-btn.active {
            color: #4a9eff;
            border-bottom-color: #4a9eff;
            background: rgba(74, 158, 255, 0.1);
        }

        .tab-btn.story-tab.active {
            color: #a855f7;
            border-bottom-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .tab-btn.ooc-tab.active {
            color: #888;
            border-bottom-color: #888;
            background: rgba(136, 136, 136, 0.1);
        }

        /* Tab badge for unread messages */
        .tab-badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            min-width: 16px;
            text-align: center;
        }

        .tab-badge.hidden {
            display: none;
        }

        /* Message tab indicator */
        .message-tab-indicator {
            font-size: 0.7em;
            color: #666;
            margin-left: 8px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Campaign Chat</h2>
        <div id="status" class="disconnected">Disconnected</div>
        
        <h3 style="margin-top: 20px; color: #ccc;">Your Info</h3>
        <div style="margin-top: 10px;">
            <input type="text" id="display-name" placeholder="Your name" 
                   style="width: 100%; padding: 8px; background: #0f3460; border: 2px solid #1e3a5f; border-radius: 4px; color: #eee; margin-bottom: 10px;">
            <input type="text" id="user-id" placeholder="User ID (UUID)" 
                   style="width: 100%; padding: 8px; background: #0f3460; border: 2px solid #1e3a5f; border-radius: 4px; color: #eee; margin-bottom: 10px;">
            <input type="text" id="campaign-id" placeholder="Campaign ID (UUID)" 
                   style="width: 100%; padding: 8px; background: #0f3460; border: 2px solid #1e3a5f; border-radius: 4px; color: #eee; margin-bottom: 10px;">
            <button onclick="connect()" style="width: 100%; margin-left: 0;">Connect</button>
        </div>
        
        <h3 style="margin-top: 20px; color: #ccc;">Connected Players</h3>
        <ul class="user-list" id="user-list">
            <li style="opacity: 0.5;">No one here yet...</li>
        </ul>
    </div>
    
    <div id="chat-container">
        <!-- Tab Bar -->
        <div id="tab-bar">
            <button class="tab-btn story-tab active" data-tab="story" onclick="switchTab('story')">
                üìñ Story <span id="story-badge" class="tab-badge hidden">0</span>
            </button>
            <button class="tab-btn ooc-tab" data-tab="ooc" onclick="switchTab('ooc')">
                üí¨ OOC <span id="ooc-badge" class="tab-badge hidden">0</span>
            </button>
        </div>

        <div id="messages"></div>
        
        <div id="input-area">
            <select id="mode">
                <option value="IC">In-Character</option>
                <option value="OOC">Out-of-Character</option>
            </select>
            <input type="text" id="message-input" placeholder="Type your message..." disabled>
            <button onclick="sendMessage()" disabled id="send-btn">Send</button>
            <button onclick="rollDice()" disabled id="roll-btn">Roll Dice</button>
        </div>
    </div>
    
    <script>
        let ws = null;
        let displayName = '';
        let userId = '';
        let campaignId = '';

        // Tab state
        let activeTab = 'story';  // 'story' or 'ooc'
        let allMessages = [];     // Store all messages with their tab info
        let unreadCounts = { story: 0, ooc: 0 };

        // Tab switching function
        function switchTab(tab) {
            activeTab = tab;

            // Update tab button styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            // Clear unread count for this tab
            unreadCounts[tab] = 0;
            updateBadge(tab);

            // Re-render messages for the active tab
            renderMessages();
        }

        // Update badge for a tab
        function updateBadge(tab) {
            const badge = document.getElementById(`${tab}-badge`);
            if (unreadCounts[tab] > 0) {
                badge.textContent = unreadCounts[tab] > 99 ? '99+' : unreadCounts[tab];
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Determine which tab a message belongs to
        function getMessageTab(data) {
            // Commands always go to Story tab, except /ooc
            if (data.is_ooc_command) {
                return 'ooc';
            }

            // Check chat_mode from server
            if (data.chat_mode === 'ooc' || data.mode === 'OOC') {
                return 'ooc';
            }

            // Combat events, dice rolls, narration go to Story
            if (['combat_result', 'combat_event', 'dice_roll', 'narration',
                 'initiative', 'stat_roll', 'defend'].includes(data.type)) {
                return 'story';
            }

            // System messages go to current active tab (or story by default)
            if (data.type === 'system') {
                return data.target_tab || 'story';
            }

            // Whispers go to Story tab
            if (data.type === 'whisper' || data.chat_mode === 'whisper') {
                return 'story';
            }

            // Default: Story for IC, OOC for explicit OOC
            return 'story';
        }

        // Render messages for the current active tab
        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            const filteredMessages = allMessages.filter(msg => msg._tab === activeTab);

            filteredMessages.forEach(data => {
                const messageDiv = createMessageElement(data);
                if (messageDiv) {
                    messagesDiv.appendChild(messageDiv);
                }
            });

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Create a message element (extracted from addMessage)
        function createMessageElement(data) {
            const messageDiv = document.createElement('div');
            const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

            // Add tab indicator for debugging
            const tabIndicator = `<span class="message-tab-indicator">${data._tab.toUpperCase()}</span>`;

            if (data.type === 'chat') {
                messageDiv.className = `message chat-${data.mode}`;
                messageDiv.innerHTML = `
                    <span class="sender">${data.sender}</span>
                    <span>${data.message}</span>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'message') {
                // Regular message from WebSocket
                const cssClass = data.chat_mode === 'ooc' ? 'chat-OOC' : 'chat-IC';
                messageDiv.className = `message ${cssClass}`;
                messageDiv.innerHTML = `
                    <span class="sender">${data.actor}</span>
                    <span>${data.text}</span>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'narration') {
                messageDiv.className = 'message narration';
                messageDiv.innerHTML = `
                    <div>üìñ ${data.text}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'combat_result' || data.type === 'combat_event') {
                messageDiv.className = 'message combat_result';
                let rollsHtml = '';
                if (data.individual_rolls) {
                    rollsHtml = data.individual_rolls.map(r =>
                        `Roll: ${r.attacker_roll} vs ${r.defense_roll} ‚Üí ${r.margin > 0 ? '+' + r.margin : r.margin} ‚Üí ${r.damage} damage`
                    ).join('<br>');
                }

                const attacker = data.attacker || data.attacker_name || 'Unknown';
                const defender = data.defender || data.defender_name || 'Unknown';
                const technique = data.technique || 'Attack';
                const damage = data.damage || data.total_damage || 0;
                const defenderDp = data.defender_new_dp !== undefined ? data.defender_new_dp : '?';
                const narrative = data.narrative || data.flavor_text || '';

                messageDiv.innerHTML = `
                    <div><strong>‚öîÔ∏è ${attacker} attacks ${defender} with ${technique}</strong></div>
                    ${rollsHtml ? `<div class="combat-breakdown">${rollsHtml}</div>` : ''}
                    <div><strong>Total: ${damage} damage (${defender} has ${defenderDp} DP remaining)</strong></div>
                    <div>${narrative}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'dice_roll') {
                messageDiv.className = 'message dice_roll';
                const breakdown = data.breakdown ? data.breakdown.join(', ') : data.rolls?.join(', ') || '?';
                messageDiv.innerHTML = `
                    <div><strong>üé≤ ${data.roller || data.actor} rolls ${data.dice}</strong></div>
                    <div>Rolls: [${breakdown}] = ${data.result}</div>
                    ${data.reason ? `<div style="font-style: italic;">${data.reason}</div>` : ''}
                    ${data.text ? `<div>${data.text}</div>` : ''}
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'initiative') {
                messageDiv.className = 'message dice_roll';
                messageDiv.innerHTML = `
                    <div><strong>‚ö° ${data.actor} rolls initiative</strong></div>
                    <div>${data.text}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'stat_roll') {
                messageDiv.className = 'message dice_roll';
                messageDiv.innerHTML = `
                    <div><strong>üìä ${data.actor} rolls ${data.stat}</strong></div>
                    <div>${data.text}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'defend') {
                messageDiv.className = 'message dice_roll';
                messageDiv.innerHTML = `
                    <div><strong>üõ°Ô∏è ${data.actor} defends</strong></div>
                    <div>${data.text}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'system') {
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div>‚ÑπÔ∏è ${data.message || data.text}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'whisper') {
                messageDiv.className = 'message whisper';
                messageDiv.innerHTML = `
                    <div>üîí <strong>${data.sender || data.actor} whispers:</strong> ${data.message || data.text}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }
            else if (data.type === 'welcome') {
                // Don't display welcome messages, just use for setup
                return null;
            }
            else {
                // Unknown type - display as generic message
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div>${JSON.stringify(data)}</div>
                    ${tabIndicator}
                    <span class="timestamp">${timestamp}</span>
                `;
            }

            return messageDiv;
        }
        
        function connect() {
            displayName = document.getElementById('display-name').value.trim();
            userId = document.getElementById('user-id').value.trim();
            campaignId = document.getElementById('campaign-id').value.trim();
            
            if (!displayName || !userId || !campaignId) {
                alert('Please fill in all fields!');
                return;
            }
            
            // Connect to WebSocket
            const wsUrl = `ws://localhost:8000/api/campaign/ws/${campaignId}?user_id=${userId}&display_name=${encodeURIComponent(displayName)}`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').className = 'connected';
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('roll-btn').disabled = false;
                addMessage({ type: 'system', message: 'Connected to campaign!' });
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addMessage(data);
            };
            
            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').className = 'disconnected';
                document.getElementById('message-input').disabled = true;
                document.getElementById('send-btn').disabled = true;
                document.getElementById('roll-btn').disabled = true;
                addMessage({ type: 'system', message: 'Disconnected from campaign.' });
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addMessage({ type: 'system', message: 'Connection error!' });
            };
        }
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const mode = document.getElementById('mode').value;
            const message = input.value.trim();

            if (!message || !ws) return;

            // Check for /ooc command - sends to OOC tab
            if (message.toLowerCase().startsWith('/ooc ')) {
                const oocMessage = message.substring(5).trim();
                if (oocMessage) {
                    ws.send(JSON.stringify({
                        type: 'message',
                        actor: displayName,
                        text: oocMessage,
                        user_id: userId,
                        chat_mode: 'ooc',
                        is_ooc_command: true
                    }));
                }
                input.value = '';
                return;
            }

            // Check for other commands (/) - these go to Story tab
            if (message.startsWith('/')) {
                ws.send(JSON.stringify({
                    type: 'message',
                    actor: displayName,
                    text: message,
                    user_id: userId,
                    chat_mode: 'ic'  // Commands go to Story/IC tab
                }));
                input.value = '';
                return;
            }

            // Regular chat message - respect the mode dropdown
            const chatMode = mode === 'OOC' ? 'ooc' : 'ic';
            ws.send(JSON.stringify({
                type: 'message',
                actor: displayName,
                text: message,
                user_id: userId,
                chat_mode: chatMode
            }));

            input.value = '';
        }
        
        function rollDice() {
            const dice = prompt('Enter dice notation (e.g., 3d6+2, 1d20):');
            if (!dice || !ws) return;
            
            ws.send(JSON.stringify({
                type: 'dice_roll',
                roller: displayName,
                user_id: userId,
                dice: dice,
                reason: null
            }));
        }
        
        function addMessage(data) {
            // Determine which tab this message belongs to
            const messageTab = getMessageTab(data);
            data._tab = messageTab;

            // Store message
            allMessages.push(data);

            // If message is for inactive tab, increment unread count
            if (messageTab !== activeTab) {
                unreadCounts[messageTab]++;
                updateBadge(messageTab);
            }

            // If message is for active tab, render it immediately
            if (messageTab === activeTab) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = createMessageElement(data);
                if (messageDiv) {
                    messagesDiv.appendChild(messageDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }
        }
        
        // Enter key to send
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
